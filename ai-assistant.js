// ==============================================
// ADVANCED AI ASSISTANT - MTA & SAMP
// ==============================================

let currentGame = 'mta';
let isGenerating = false;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Game selection
    const gameButtons = document.querySelectorAll('.game-select-btn');
    gameButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            gameButtons.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentGame = this.dataset.game;
            updateGameUI();
        });
    });
    
    updateGameUI();
});

// Update UI based on game
function updateGameUI() {
    const gameTitle = document.getElementById('gameTitle');
    const gameIcon = document.getElementById('gameIcon');
    const examples = document.getElementById('aiExamples');
    
    if (currentGame === 'mta') {
        gameTitle.textContent = 'MTA:SA Lua Script Generator';
        gameIcon.className = 'fas fa-gamepad';
        examples.innerHTML = `
            <div class="example-item" onclick="fillExample(this)">
                <span class="example-badge">MTA</span>
                <span>/heal command for admins</span>
            </div>
            <div class="example-item" onclick="fillExample(this)">
                <span class="example-badge">MTA</span>
                <span>Car dealership system with GUI</span>
            </div>
            <div class="example-item" onclick="fillExample(this)">
                <span class="example-badge">MTA</span>
                <span>Login/register with MySQL</span>
            </div>
        `;
    } else {
        gameTitle.textContent = 'SA-MP Pawn Script Generator';
        gameIcon.className = 'fas fa-server';
        examples.innerHTML = `
            <div class="example-item" onclick="fillExample(this)">
                <span class="example-badge" style="background:#9b59b6;">SAMP</span>
                <span>/heal command for admins</span>
            </div>
            <div class="example-item" onclick="fillExample(this)">
                <span class="example-badge" style="background:#9b59b6;">SAMP</span>
                <span>Vehicle dealership system</span>
            </div>
            <div class="example-item" onclick="fillExample(this)">
                <span class="example-badge" style="background:#9b59b6;">SAMP</span>
                <span>House system with MySQL</span>
            </div>
        `;
    }
}

// Main AI generation function
window.generateMTAscript = async function() {
    if (isGenerating) return;
    
    const input = document.getElementById('aiDescription');
    const output = document.getElementById('aiCodeOutput');
    
    if (!input || !input.value.trim()) {
        showCoolNotification('üìù Please describe what you need!', 'info');
        return;
    }
    
    isGenerating = true;
    const userRequest = input.value.trim();
    
    // Show cool loading animation
    output.innerHTML = createLoadingScreen();
    output.style.display = 'block';
    
    // Add typing animation effect
    const loadingText = output.querySelector('.loading-text');
    let dots = 0;
    const dotInterval = setInterval(() => {
        dots = (dots + 1) % 4;
        loadingText.textContent = 'AI is generating your code' + '.'.repeat(dots);
    }, 500);
    
    try {
        const aiResponse = await callAI(userRequest, currentGame);
        
        clearInterval(dotInterval);
        output.innerHTML = createResultScreen(aiResponse);
        
        // Scroll to result
        output.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        // Show success notification
        showCoolNotification('‚ú® Code Generated Successfully!', 'success');
        
    } catch (error) {
        clearInterval(dotInterval);
        output.innerHTML = createErrorScreen(error);
        showCoolNotification('‚ùå AI Generation Failed', 'error');
    } finally {
        isGenerating = false;
    }
};

// Call DeepSeek API (100% FREE)
async function callAI(userPrompt, game) {
    const systemPrompt = game === 'mta' 
        ? `You are an expert MTA:SA Lua programmer. Generate complete, working MTA Lua scripts.
           IMPORTANT: Start with: "üî• Generated by Louay Zaid's AI Assistant üî•"
           Then provide the code in \`\`\`lua code blocks.
           Include proper error handling, admin checks, and comments.
           Make sure code is fully functional and tested.`
        : `You are an expert SA-MP Pawn programmer. Generate complete, working Pawn scripts.
           IMPORTANT: Start with: "üî• Generated by Louay Zaid's AI Assistant üî•"
           Then provide the code in \`\`\`pawn code blocks.
           Include proper error handling, admin checks, and comments.
           Make sure code is fully functional and tested.`;
    
    try {
        const response = await fetch("https://api.deepseek.com/chat/completions", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer sk-5a8d4c7d9b2e4f6a8c3d7e9f1a2b4c6d"  // DeepSeek test key
            },
            body: JSON.stringify({
                model: "deepseek-chat",
                messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: userPrompt }
                ],
                max_tokens: 4000,
                temperature: 0.7,
                stream: false
            })
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error("DeepSeek API Error:", response.status, errorText);
            
            if (response.status === 429) {
                throw new Error('AI is busy. Please try again in 30 seconds.');
            } else if (response.status === 401) {
                throw new Error('AI service needs update. Contact admin.');
            } else {
                throw new Error(`AI Error: ${response.status}`);
            }
        }
        
        const data = await response.json();
        return data.choices[0].message.content;
        
    } catch (error) {
        console.error("DeepSeek call failed:", error);
        throw error;
    }
}

// UI Components (keep existing)
function createLoadingScreen() {
    return `
    <div class="ai-loading-screen">
        <div class="loading-sparkle">
            <div class="sparkle"></div>
            <div class="sparkle"></div>
            <div class="sparkle"></div>
        </div>
        <div class="loading-signature">
            <div class="signature-line"></div>
            <div class="signature-name">Louay Zaid</div>
            <div class="signature-line"></div>
        </div>
        <div class="loading-text">AI is generating your code</div>
        <div class="loading-subtext">Powered By DeepSeek AI ‚Ä¢ 100% Free Forever</div>
    </div>`;
}

function createResultScreen(aiResponse) {
    let formattedResponse = aiResponse;
    
    formattedResponse = formattedResponse.replace(/```(\w+)?\n([\s\S]*?)```/g, 
        '<div class="code-block"><div class="code-header">$1</div><pre class="language-$1">$2</pre></div>');
    
    return `
    <div class="ai-result-screen">
        <div class="result-header">
            <div class="game-badge ${currentGame}">
                <i class="fas ${currentGame === 'mta' ? 'fa-gamepad' : 'fa-server'}"></i>
                ${currentGame.toUpperCase()}
            </div>
            <div class="signature-watermark">
                <i class="fas fa-bolt"></i> Powered by DeepSeek AI
            </div>
        </div>
        
        <div class="generated-content">
            ${formattedResponse}
        </div>
        
        <div class="result-actions">
            <button onclick="copyAICode()" class="action-btn copy-btn">
                <i class="fas fa-copy"></i> Copy Code
            </button>
            <button onclick="useInUpload()" class="action-btn upload-btn">
                <i class="fas fa-upload"></i> Use in Upload
            </button>
            <button onclick="generateMTAscript()" class="action-btn regenerate-btn">
                <i class="fas fa-redo"></i> Generate Again
            </button>
        </div>
        
        <div class="result-footer">
            <div class="powered-by">
                <i class="fas fa-crown"></i> By Louay Zaid ‚Ä¢ 
                <i class="fas fa-robot"></i> DeepSeek AI ‚Ä¢ 100% Free Forever
            </div>
        </div>
    </div>`;
}

function createErrorScreen(error) {
    return `
    <div class="ai-error-screen">
        <div class="error-icon">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h3>AI Generation Failed</h3>
        <div class="error-message">${error.message}</div>
        
        <div class="error-solutions">
            <h4>Quick Fixes:</h4>
            <ul style="text-align: left; color: #a0a0d0; padding-left: 20px;">
                <li>Try a simpler description</li>
                <li>Wait 30 seconds and try again</li>
                <li>Check your internet connection</li>
                <li>Example: "/heal command for admins"</li>
            </ul>
        </div>
        
        <button onclick="generateMTAscript()" class="error-btn" style="margin-top: 20px; padding: 12px 30px; background: #6a11cb; color: white; border: none; border-radius: 8px; cursor: pointer;">
            <i class="fas fa-redo"></i> Try Again
        </button>
    </div>`;
}

// Copy code with cool notification
window.copyAICode = function() {
    const codeBlocks = document.querySelectorAll('.code-block pre');
    if (codeBlocks.length === 0) return;
    
    let allCode = '';
    codeBlocks.forEach(block => {
        allCode += block.textContent + '\n\n';
    });
    
    navigator.clipboard.writeText(allCode).then(() => {
        showCoolNotification('üìã Code Copied to Clipboard!', 'success');
        
        const copyBtn = document.querySelector('.copy-btn');
        if (copyBtn) {
            const originalHTML = copyBtn.innerHTML;
            copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
            copyBtn.style.background = '#00b894';
            
            setTimeout(() => {
                copyBtn.innerHTML = originalHTML;
                copyBtn.style.background = '';
            }, 2000);
        }
    });
};

// Cool notification system
function showCoolNotification(message, type = 'info') {
    const existing = document.getElementById('cool-notification');
    if (existing) existing.remove();
    
    const notification = document.createElement('div');
    notification.id = 'cool-notification';
    notification.className = `cool-notification ${type}`;
    
    const icons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        info: 'fa-info-circle',
        warning: 'fa-exclamation-triangle'
    };
    
    notification.innerHTML = `
        <div class="notification-content">
            <i class="fas ${icons[type] || 'fa-info-circle'}"></i>
            <span>${message}</span>
        </div>
        <div class="notification-progress"></div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => notification.classList.add('show'), 10);
    
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, 4000);
}

// Fill example text
window.fillExample = function(element) {
    const text = element.querySelector('span:last-child').textContent;
    document.getElementById('aiDescription').value = text;
    showCoolNotification('üìù Example loaded!', 'info');
};

// Use in upload
window.useInUpload = function() {
    const codeBlocks = document.querySelectorAll('.code-block pre');
    if (codeBlocks.length === 0) return;
    
    let allCode = '';
    codeBlocks.forEach(block => {
        allCode += block.textContent + '\n\n';
    });
    
    const uploadNav = document.querySelector('[data-section="upload"]');
    if (uploadNav) {
        uploadNav.click();
        
        setTimeout(() => {
            const descField = document.getElementById('fileDescription');
            if (descField) {
                descField.value = `AI Generated ${currentGame.toUpperCase()} Script:\n\n` + allCode;
                showCoolNotification('üì§ Code loaded into upload form!', 'success');
            }
        }, 500);
    }
};